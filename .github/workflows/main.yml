name: Image Build & Push Deploy

on:
  push:
    branches: [ main ]

jobs:
  build-and-cloud-connect:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: '${{ secrets.GCP_SA_KEY }}'

      - name: Set up gcloud CLI
        uses: google-github-actions/setup-gcloud@v1

      - name: Docker Login to GAR
        run: |
          echo '${{ secrets.GCP_SA_KEY }}' > gcp-key.json
          cat gcp-key.json | docker login -u _json_key --password-stdin https://asia-northeast3-docker.pkg.dev
          echo "GAR 로그인 성공"
          rm gcp-key.json # 보안을 위해 삭제

      - name: Front Server Push
        working-directory: ./mensclub-pwa
        run: |
          set -e
          echo "프론트 서버 이미지 빌딩 중..."
          docker build -t ${{ secrets.FRONT_REPO_NAME }} . -f Dockerfile.React
          docker push ${{ secrets.FRONT_REPO_NAME }}
          echo "프론트 서버 이미지 Push 완료"

      - name: Back Server Push
        working-directory: ./service
        run: |
          set -e
          echo "백엔드 서버 이미지 빌딩 중..."
          docker build -t ${{ secrets.BACK_REPO_NAME }} . -f Dockerfile.django
          docker push ${{ secrets.BACK_REPO_NAME }}
          echo "백엔드 서버 이미지 Push 완료"

      - name: Proxy Server Push
        working-directory: ./service
        run: |
          set -e
          echo "프록시 서버 이미지 빌딩 중..."
          docker build -t ${{ secrets.PROXY_REPO_NAME }} . -f Dockerfile.proxy
          docker push ${{ secrets.PROXY_REPO_NAME }}
          echo "프록시 서버 이미지 Push 완료"

      - name: Connect to server and check directory
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            echo "서버 접속 성공"
            pwd
            ls -la
            echo "현재 디렉토리 확인 완료"
